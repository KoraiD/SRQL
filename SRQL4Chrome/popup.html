<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<HTML>
   <HEAD>
<TITLE>SRQL query builder</TITLE>
<link rel="icon" 
type="image/ico" 
href="images/favicon.ico">
<script src="scripts/rollbar.js"></script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/jquery-ui.min.js"></script>
<link rel="stylesheet" href="styles/styles.css">
<link rel="stylesheet" href="styles/jquery-ui.min.css">
    </HEAD>
   <BODY>
<script>
Rollbar.info("Query builder inicialized");
</script>
  <script>
    $( document ).ready(function() {
      var offset = $('.dropzone').offset();
      x_pos = offset.left;
      y_pos = offset.top;
      width = offset.width;
      table = [["frame", x_pos, y_pos]];
      //Rollbar.debug("Dropzone pos: " + String(x_pos));
    });

//TODO: add destroy box - remove dropped elements
  $( function dragFunction() {
    $( ".drag-drop" ).draggable({ snap: true, 
      start: function(){
        var startOffset = $(this).offset();
        startxPos = startOffset.left;
        startyPos = startOffset.top;
      },
      stop: function() {
        var offset = $(this).offset();
        var xPos = offset.left;
        var yPos = offset.top;
        var id = $(this).attr('id');

        let index = table.findIndex(x => x[0] === id);

        if (index !== -1) {
          table[index] = [id, xPos, yPos];
        }
        else{
          table.push([id, xPos, yPos]);
        }

        //console.log(id + " " + startyPos + " " + y_pos + " X: " + startxPos + " " + x_pos);
        //TODO: handle each dropzone coordinate
        //TDOD: remove unnecessary logs
        if(id =="any_input" & (startyPos<y_pos) & (yPos>=y_pos & xPos>=x_pos)){
          var $div = $("<div>", {id: "any_input", "class": "drag-drop"});
          var $input = $("<input>", {id:"any_text", "class": "input-block"});
          $("#opt_box").append($div);
          $div.append($input);
          $div.draggable({snap: true});
          dragFunction();
        }
        Rollbar.debug("current div ID: " + String(id));
        Rollbar.debug("PositionX: " + String(xPos));
    }
    });
    $( ".stick" ).draggable({ snap: ".dropzone" });
  } );
  </script>

<script>
  function round(x) { 
    if (x % 25 == 0) { 
        return parseInt(Math.floor(x / 25)) * 25; 
    } else { 
        return (parseInt(Math.floor(x / 25)) * 25) + 25; 
    } 
  } 

  function Convert() {

    var roundTable = function(arr) {
      if ( typeof(arr) == "object") {
          for (var i = 0; i < arr.length; i++) {
              roundTable(arr[i]);
          }
      }
      else arr[1] = round(arr[1]); 
    }
    
    roundTable(table);
    var sortedTable = table.sort(function(a, b) {
      if (a[2] == b[2]) {
        return a[1] - b[1];
      }
      return a[2] - b[2];
    });
    console.log(table)
    console.log(sortedTable);
  }
  document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('conv_btn').addEventListener('click', Convert);
    });
</script> 

  <script>
    function DocsTab() {
      Rollbar.info("RQL docs requested");
        window.open( 
          "https://docs.rollbar.com/docs/rql", "_blank"); 
    } 
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('rql_btn').addEventListener('click', DocsTab);
      });
  </script> 
<div class="enclosure">

<div class="items">

  <div id ="req_box" class="store">Required
    <div id="select" class="stick">Select</div>
    <div id="from" class="drag-drop">From</div>
    <div id="table" class="drag-drop">
      <select name="tables" id="tbl_pick">
        <option value="it_oc">item_occurence</option>
        <option value="deploy">deploy</option>
      </select>
    </div>
    <div id="where" class="drag-drop">Where</div>
  </div>

  <div id ="opt_box" class="store">Optional
    <div id="star" class="drag-drop">*</div>
    <div id="group_by" class="drag-drop">Group by</div>
    <div id="order_by" class="drag-drop">Order by</div>
    <div id="limit" class="drag-drop">Limit</div>
    <!--TODO: make textbox width dynamic, make size equal with the other elements-->
    <div id="any_input" class="drag-drop">
      <input id="any_text" class="input-block">
    </div>
  </div>

<!--
    <div id ="opt_box" class="store">Operators
    <div id="add" class="drag-drop">+</div>
  </div>

  <div id ="opt_box" class="store">Functions
    <div id="count" class="drag-drop">Count(*)</div>
  </div>
-->
    <div id="dropzone" class="dropzone"></div>

    <div id="rql_viewer" class="viewer"></div>

    <button id="rql_btn" class="button">RQL docs</button>
    <button id="conv_btn" class="button">Convert</button>
</div>

</div>
   </BODY>
</HTML>
